# Flutter Firebase Push Notifications Setup

This guide will help you set up Firebase Cloud Messaging (FCM) for push notifications in your Flutter app.

## Prerequisites

- Firebase project (same one used for the backend)
- Flutter development environment
- Android Studio / Xcode for platform-specific setup

## Step 1: Install FlutterFire CLI

```bash
dart pub global activate flutterfire_cli
```

## Step 2: Configure Firebase for Flutter

Run the following command in your Flutter project root:

```bash
flutterfire configure
```

This will:
1. Ask you to select your Firebase project
2. Generate platform-specific configuration files
3. Update your `pubspec.yaml` with required dependencies

**Manual alternative:** Follow the [FlutterFire documentation](https://firebase.flutter.dev/docs/overview)

## Step 3: Add Dependencies

Add these to your `pubspec.yaml`:

```yaml
dependencies:
  firebase_core: ^2.24.0
  firebase_messaging: ^14.7.6
  flutter_local_notifications: ^16.3.0
```

Then run:
```bash
flutter pub get
```

## Step 4: Android Configuration

### 4.1 Update `android/app/build.gradle`

```gradle
android {
    // ... other config
    
    defaultConfig {
        // ...
        minSdkVersion 21  // FCM requires at least 21
    }
}
```

### 4.2 Update `AndroidManifest.xml`

Add these inside `<application>` tag in `android/app/src/main/AndroidManifest.xml`:

```xml
<application>
    <!-- ... other config -->
    
    <!-- FCM default notification channel -->
    <meta-data
        android:name="com.google.firebase.messaging.default_notification_channel_id"
        android:value="tickets" />
    
    <!-- FCM notification icon -->
    <meta-data
        android:name="com.google.firebase.messaging.default_notification_icon"
        android:resource="@mipmap/ic_launcher" />
</application>
```

### 4.3 Add Internet Permission

Ensure this is in `AndroidManifest.xml` (should already be there):

```xml
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
```

## Step 5: iOS Configuration

### 5.1 Update `ios/Runner/AppDelegate.swift`

```swift
import UIKit
import Flutter
import FirebaseCore
import FirebaseMessaging

@UIApplicationMain
@objc class AppDelegate: FlutterAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    // Initialize Firebase
    FirebaseApp.configure()
    
    // Request notification permissions
    if #available(iOS 10.0, *) {
      UNUserNotificationCenter.current().delegate = self
      let authOptions: UNAuthorizationOptions = [.alert, .badge, .sound]
      UNUserNotificationCenter.current().requestAuthorization(
        options: authOptions,
        completionHandler: {_, _ in })
    } else {
      let settings: UIUserNotificationSettings =
      UIUserNotificationSettings(types: [.alert, .badge, .sound], categories: nil)
      application.registerUserNotificationSettings(settings)
    }

    application.registerForRemoteNotifications()
    
    GeneratedPluginRegistrant.register(with: self)
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
```

### 5.2 Add Push Notification Capability

1. Open `ios/Runner.xcworkspace` in Xcode
2. Select your project in the navigator
3. Select the "Runner" target
4. Go to "Signing & Capabilities" tab
5. Click "+ Capability" and add "Push Notifications"
6. Also add "Background Modes" and check:
   - Remote notifications
   - Background fetch

### 5.3 Upload APNs Certificate to Firebase

1. Go to [Apple Developer Center](https://developer.apple.com/account/)
2. Create an APNs Auth Key
3. Go to Firebase Console â†’ Project Settings â†’ Cloud Messaging
4. Upload the APNs Auth Key

## Step 6: Initialize Firebase in Flutter

Update your `lib/main.dart`:

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:cal_ai/services/fcm_service.dart';
import 'package:cal_ai/services/api_service_provider.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  runApp(
    ProviderScope(
      child: MyApp(),
    ),
  );
}

class MyApp extends ConsumerStatefulWidget {
  @override
  ConsumerState<MyApp> createState() => _MyAppState();
}

class _MyAppState extends ConsumerState<MyApp> {
  @override
  void initState() {
    super.initState();
    _initializeFCM();
  }

  Future<void> _initializeFCM() async {
    // Wait a bit for providers to be ready
    await Future.delayed(const Duration(seconds: 1));
    
    try {
      final apiService = ref.read(apiServiceProvider);
      await FCMService().initialize(apiService);
    } catch (e) {
      print('Error initializing FCM: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    // ... your app widget
  }
}
```

## Step 7: Handle Logout

When user logs out, unregister the FCM token:

```dart
Future<void> logout() async {
  final apiService = ref.read(apiServiceProvider);
  await FCMService().unregisterToken(apiService);
  
  // Continue with your logout flow
  // ...
}
```

## Step 8: Testing

### Test on Android

1. Build and run the app:
   ```bash
   flutter run
   ```

2. Check logs for FCM token:
   ```
   ðŸ“± FCM Token obtained: xxxxxx...
   âœ… FCM token registered with server
   ```

3. Trigger a notification from the backend (admin replies to ticket)

4. You should see:
   - Notification in system tray when app is in background
   - In-app notification when app is in foreground

### Test on iOS

1. **Important**: Push notifications only work on physical devices, not simulators

2. Build and run on a physical device:
   ```bash
   flutter run
   ```

3. When app asks for notification permission, tap "Allow"

4. Check logs for FCM token registration

5. Trigger a notification from backend

## Troubleshooting

### Android Issues

**Issue**: No notification received
- **Solution**: Check that Google Play Services is installed and updated
- **Solution**: Verify `google-services.json` is in `android/app/`
- **Solution**: Check Firebase Console logs for delivery errors

**Issue**: App crashes on launch
- **Solution**: Ensure `minSdkVersion` is at least 21
- **Solution**: Rebuild the app: `flutter clean && flutter build apk`

### iOS Issues

**Issue**: No notification permission prompt
- **Solution**: Delete and reinstall the app
- **Solution**: Check Xcode capabilities are properly set

**Issue**: Token not generated
- **Solution**: Verify APNs certificate is uploaded to Firebase
- **Solution**: Check device has internet connection
- **Solution**: Ensure running on physical device, not simulator

**Issue**: Notifications not received
- **Solution**: Check iOS Settings â†’ Your App â†’ Notifications are enabled
- **Solution**: Verify APNs certificate is not expired

### General Issues

**Issue**: FCM token not sent to server
- **Solution**: Check API endpoint is correct: `/api/fcm/register`
- **Solution**: Verify user is authenticated (JWT token present)
- **Solution**: Check server logs for registration attempts

**Issue**: Old notifications not showing
- **Solution**: Clear app data/cache and reinstall
- **Solution**: Check Firebase Console â†’ Cloud Messaging for delivery status

## Testing Push Notifications

### Method 1: Via Backend API

```bash
# Admin replies to a ticket
curl -X POST http://your-server.com/api/tickets/TICKET_ID/messages \
  -H "Authorization: Bearer ADMIN_JWT" \
  -H "Content-Type: application/json" \
  -d '{"message":"Test notification"}'
```

### Method 2: Via Firebase Console

1. Go to Firebase Console â†’ Cloud Messaging
2. Click "Send your first message"
3. Enter notification title and text
4. Select your app
5. Click "Test on device"
6. Enter your FCM token (from app logs)
7. Click "Test"

### Method 3: Via Postman

```
POST https://fcm.googleapis.com/fcm/send
Headers:
  Authorization: key=YOUR_SERVER_KEY
  Content-Type: application/json

Body:
{
  "to": "USER_FCM_TOKEN",
  "notification": {
    "title": "Test Notification",
    "body": "This is a test"
  },
  "data": {
    "ticketId": "123"
  }
}
```

## Best Practices

1. **Request permissions at the right time**: Don't ask on first launch, wait for user to perform an action that needs notifications

2. **Handle token refresh**: FCM tokens can change, our service handles this automatically

3. **Clean up on logout**: Always unregister tokens when user logs out

4. **Test on real devices**: Especially for iOS, always test on physical devices

5. **Monitor logs**: Keep an eye on server logs for delivery failures and invalid tokens

6. **Graceful degradation**: App should work fine even if FCM initialization fails

## Production Checklist

- [ ] Firebase project is in production mode
- [ ] APNs certificate uploaded (iOS)
- [ ] google-services.json configured (Android)
- [ ] GoogleService-Info.plist configured (iOS)
- [ ] Server has valid Firebase Admin SDK credentials
- [ ] Notification permissions requested appropriately
- [ ] Token registration on login implemented
- [ ] Token unregistration on logout implemented
- [ ] Tested on both Android and iOS physical devices
- [ ] Notification tapping navigates to correct screen
- [ ] Background and foreground notifications work
- [ ] Notification icons and sounds configured

## Additional Resources

- [Firebase Cloud Messaging Documentation](https://firebase.google.com/docs/cloud-messaging)
- [FlutterFire Messaging Plugin](https://firebase.flutter.dev/docs/messaging/overview)
- [Flutter Local Notifications Plugin](https://pub.dev/packages/flutter_local_notifications)
- [Firebase Console](https://console.firebase.google.com)
